<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUARDIAN - Solana Immune System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --guardian-cyan: #00f0ff;
            --guardian-red: #ff4757;
            --guardian-green: #2ed573;
            --guardian-yellow: #ffa502;
            --guardian-purple: #a855f7;
            --guardian-bg: #0a0a0f;
            --guardian-card: #12121a;
            --guardian-border: #1e1e2e;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--guardian-bg);
            background-image: 
                radial-gradient(ellipse at top, rgba(0, 240, 255, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
            min-height: 100vh;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .card {
            background: var(--guardian-card);
            border: 1px solid var(--guardian-border);
            border-radius: 12px;
        }
        
        .glow-cyan { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); }
        .glow-red { box-shadow: 0 0 20px rgba(255, 71, 87, 0.2); }
        .glow-green { box-shadow: 0 0 20px rgba(46, 213, 115, 0.2); }
        
        .stat-number {
            background: linear-gradient(135deg, var(--guardian-cyan), var(--guardian-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .threat-row { transition: all 0.2s ease; }
        .threat-row:hover { background: rgba(255,255,255,0.02); }
        
        .severity-critical { color: var(--guardian-red); }
        .severity-high { color: var(--guardian-yellow); }
        .severity-medium { color: #f59e0b; }
        .severity-low { color: var(--guardian-green); }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .scroll-area {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .scroll-area::-webkit-scrollbar-track {
            background: var(--guardian-bg);
        }
        
        .scroll-area::-webkit-scrollbar-thumb {
            background: var(--guardian-border);
            border-radius: 3px;
        }
    </style>
</head>
<body class="text-gray-100" x-data="guardianApp()" x-init="init()">
    <!-- Header -->
    <header class="border-b border-gray-800 bg-black/50 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üõ°Ô∏è</div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight">GUARDIAN</h1>
                        <p class="text-xs text-gray-500">Solana Immune System</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-green-500 pulse' : 'bg-red-500'"></span>
                        <span class="text-sm text-gray-400" x-text="connected ? 'Connected' : 'Disconnected'"></span>
                    </div>
                    <div class="text-sm font-mono text-gray-500" x-text="status.network || 'devnet'"></div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Active Threats -->
            <div class="card p-6 glow-red">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-400 text-sm">Active Threats</span>
                    <span class="text-red-500">üö®</span>
                </div>
                <div class="text-4xl font-bold stat-number" x-text="status.threats?.active || 0"></div>
                <div class="text-xs text-gray-500 mt-2">
                    <span x-text="status.threats?.last_24h || 0"></span> in last 24h
                </div>
            </div>
            
            <!-- Resolved -->
            <div class="card p-6 glow-green">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-400 text-sm">Resolved</span>
                    <span class="text-green-500">‚úÖ</span>
                </div>
                <div class="text-4xl font-bold stat-number" x-text="status.threats?.resolved || 0"></div>
                <div class="text-xs text-gray-500 mt-2">
                    Avg severity: <span x-text="(status.threats?.avg_severity || 0).toFixed(1)"></span>
                </div>
            </div>
            
            <!-- Agents -->
            <div class="card p-6 glow-cyan">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-400 text-sm">Active Agents</span>
                    <span class="text-cyan-500">ü§ñ</span>
                </div>
                <div class="text-4xl font-bold stat-number" x-text="status.agents?.count || 0"></div>
                <div class="text-xs text-gray-500 mt-2">
                    <span x-text="status.agents?.total_scans || 0"></span> total scans
                </div>
            </div>
            
            <!-- Intelligence -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-400 text-sm">Intelligence</span>
                    <span class="text-purple-500">üß†</span>
                </div>
                <div class="text-4xl font-bold stat-number" x-text="status.intelligence?.patterns || 0"></div>
                <div class="text-xs text-gray-500 mt-2">
                    <span x-text="status.intelligence?.blacklisted || 0"></span> blacklisted
                </div>
            </div>
        </div>
        
        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Threats List -->
            <div class="lg:col-span-2 card">
                <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                    <h2 class="font-semibold">Recent Threats</h2>
                    <div class="flex gap-2">
                        <button @click="filterThreats('all')" 
                                :class="threatFilter === 'all' ? 'bg-cyan-500/20 text-cyan-400' : 'text-gray-500'"
                                class="px-3 py-1 rounded-lg text-sm transition">All</button>
                        <button @click="filterThreats('active')" 
                                :class="threatFilter === 'active' ? 'bg-red-500/20 text-red-400' : 'text-gray-500'"
                                class="px-3 py-1 rounded-lg text-sm transition">Active</button>
                    </div>
                </div>
                
                <div class="scroll-area">
                    <table class="w-full">
                        <thead class="text-xs text-gray-500 uppercase border-b border-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left">Type</th>
                                <th class="px-4 py-3 text-left">Target</th>
                                <th class="px-4 py-3 text-center">Severity</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="threat in threats" :key="threat.id">
                                <tr class="threat-row border-b border-gray-800/50 cursor-pointer" 
                                    @click="selectThreat(threat)">
                                    <td class="px-4 py-3">
                                        <span class="font-mono text-sm" x-text="threat.threat_type"></span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="font-mono text-xs text-gray-400" 
                                              x-text="threat.target_address ? threat.target_address.slice(0,12) + '...' : '-'"></span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="font-bold" 
                                              :class="getSeverityClass(threat.severity)"
                                              x-text="threat.severity.toFixed(0)"></span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs"
                                              :class="threat.status === 'active' ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'"
                                              x-text="threat.status"></span>
                                    </td>
                                    <td class="px-4 py-3 text-xs text-gray-500" x-text="formatTime(threat.detected_at)"></td>
                                </tr>
                            </template>
                            <tr x-show="threats.length === 0">
                                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                    No threats detected
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Risk Scorer -->
                <div class="card p-4">
                    <h3 class="font-semibold mb-4">üéØ Risk Scorer</h3>
                    <form @submit.prevent="scoreAddress()">
                        <input type="text" 
                               x-model="scoreInput"
                               placeholder="Enter Solana address..."
                               class="w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-2 text-sm font-mono focus:border-cyan-500 focus:outline-none mb-3">
                        <button type="submit" 
                                class="w-full bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30 rounded-lg px-4 py-2 text-sm transition">
                            Analyze Risk
                        </button>
                    </form>
                    
                    <div x-show="scoreResult" class="mt-4 p-4 bg-black/30 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-400 text-sm">Risk Score</span>
                            <span class="text-2xl font-bold" 
                                  :class="getSeverityClass(scoreResult?.risk_score || 0)"
                                  x-text="(scoreResult?.risk_score || 0).toFixed(1)"></span>
                        </div>
                        <div class="text-xs text-gray-500">
                            Recommendation: <span class="text-cyan-400" x-text="scoreResult?.recommendation"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Status -->
                <div class="card p-4">
                    <h3 class="font-semibold mb-4">ü§ñ Agents</h3>
                    <div class="space-y-2 scroll-area" style="max-height: 200px;">
                        <template x-for="agent in agents" :key="agent.agent_id">
                            <div class="flex items-center justify-between p-2 bg-black/30 rounded-lg">
                                <div>
                                    <div class="text-sm font-medium" x-text="agent.agent_type"></div>
                                    <div class="text-xs text-gray-500">
                                        <span x-text="agent.threats_detected"></span> threats
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-mono" 
                                         :class="agent.accuracy_score >= 80 ? 'text-green-400' : 'text-yellow-400'"
                                         x-text="agent.accuracy_score + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Blacklist Preview -->
                <div class="card p-4">
                    <h3 class="font-semibold mb-4">üö´ Blacklist</h3>
                    <div class="space-y-2 scroll-area" style="max-height: 150px;">
                        <template x-for="addr in blacklist.slice(0, 5)" :key="addr.address">
                            <div class="flex items-center justify-between p-2 bg-black/30 rounded-lg">
                                <span class="font-mono text-xs text-gray-400" x-text="addr.address.slice(0,16) + '...'"></span>
                                <span class="text-xs text-red-400" x-text="addr.severity"></span>
                            </div>
                        </template>
                        <div x-show="blacklist.length === 0" class="text-center text-gray-500 text-sm py-4">
                            No blacklisted addresses
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Threat Detail Modal -->
        <div x-show="selectedThreat" 
             x-transition
             class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"
             @click.self="selectedThreat = null">
            <div class="card max-w-2xl w-full max-h-[80vh] overflow-auto">
                <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                    <h3 class="font-semibold">Threat Details</h3>
                    <button @click="selectedThreat = null" class="text-gray-500 hover:text-white">‚úï</button>
                </div>
                <div class="p-6" x-show="selectedThreat">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="text-xs text-gray-500">Type</label>
                            <div class="font-mono" x-text="selectedThreat?.threat_type"></div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Severity</label>
                            <div class="font-bold text-2xl" 
                                 :class="getSeverityClass(selectedThreat?.severity || 0)"
                                 x-text="selectedThreat?.severity?.toFixed(1)"></div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Status</label>
                            <div x-text="selectedThreat?.status"></div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Detected By</label>
                            <div x-text="selectedThreat?.detected_by"></div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-xs text-gray-500">Target Address</label>
                        <div class="font-mono text-sm bg-black/30 p-2 rounded" x-text="selectedThreat?.target_address || 'N/A'"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-xs text-gray-500">Description</label>
                        <div class="text-sm text-gray-300" x-text="selectedThreat?.description"></div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-gray-500">Evidence</label>
                        <pre class="font-mono text-xs bg-black/30 p-3 rounded overflow-auto max-h-40"
                             x-text="JSON.stringify(selectedThreat?.evidence, null, 2)"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-12 py-6">
        <div class="container mx-auto px-6 text-center text-sm text-gray-500">
            GUARDIAN - Solana Immune System | Protecting the ecosystem 24/7
        </div>
    </footer>
    
    <script>
        function guardianApp() {
            return {
                connected: false,
                ws: null,
                status: {},
                threats: [],
                agents: [],
                blacklist: [],
                threatFilter: 'all',
                selectedThreat: null,
                scoreInput: '',
                scoreResult: null,
                
                async init() {
                    await this.fetchStatus();
                    await this.fetchThreats();
                    await this.fetchAgents();
                    await this.fetchBlacklist();
                    this.connectWebSocket();
                    
                    // Refresh every 30s
                    setInterval(() => this.fetchStatus(), 30000);
                    setInterval(() => this.fetchThreats(), 15000);
                },
                
                connectWebSocket() {
                    const wsUrl = `ws://${window.location.hostname}:8000/ws`;
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.connected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onclose = () => {
                        this.connected = false;
                        console.log('WebSocket disconnected, reconnecting...');
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                    
                    this.ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        this.handleWebSocketMessage(msg);
                    };
                },
                
                handleWebSocketMessage(msg) {
                    if (msg.type === 'threat_created') {
                        this.threats.unshift(msg.data);
                        this.fetchStatus();
                    }
                },
                
                async fetchStatus() {
                    try {
                        const res = await fetch('/api/status');
                        this.status = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch status:', e);
                    }
                },
                
                async fetchThreats() {
                    try {
                        const filter = this.threatFilter === 'active' ? '?status=active' : '';
                        const res = await fetch(`/api/threats${filter}&limit=50`);
                        const data = await res.json();
                        this.threats = data.threats || [];
                    } catch (e) {
                        console.error('Failed to fetch threats:', e);
                    }
                },
                
                async fetchAgents() {
                    try {
                        const res = await fetch('/api/agents');
                        const data = await res.json();
                        this.agents = data.agents || [];
                    } catch (e) {
                        console.error('Failed to fetch agents:', e);
                    }
                },
                
                async fetchBlacklist() {
                    try {
                        const res = await fetch('/api/blacklist');
                        const data = await res.json();
                        this.blacklist = data.addresses || [];
                    } catch (e) {
                        console.error('Failed to fetch blacklist:', e);
                    }
                },
                
                filterThreats(filter) {
                    this.threatFilter = filter;
                    this.fetchThreats();
                },
                
                selectThreat(threat) {
                    this.selectedThreat = threat;
                },
                
                async scoreAddress() {
                    if (!this.scoreInput) return;
                    
                    try {
                        const res = await fetch('/api/score', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address: this.scoreInput })
                        });
                        this.scoreResult = await res.json();
                    } catch (e) {
                        console.error('Failed to score address:', e);
                    }
                },
                
                getSeverityClass(severity) {
                    if (severity >= 80) return 'severity-critical';
                    if (severity >= 60) return 'severity-high';
                    if (severity >= 40) return 'severity-medium';
                    return 'severity-low';
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = (now - date) / 1000;
                    
                    if (diff < 60) return 'Just now';
                    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                    return date.toLocaleDateString();
                }
            };
        }
    </script>
</body>
</html>
